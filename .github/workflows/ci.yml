name: CI
on:
    push: { branches: [main] }
    pull_request:
jobs:
    test:
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest, macos-latest]
        runs-on: ${{ matrix.os }}
        steps:
            - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6
            - uses: dtolnay/rust-toolchain@6d9817901c499d6b02debbb57edb38d33daa680b # stable
              with:
                  toolchain: stable
                  components: clippy, rustfmt
            - name: Linux setup
              if: matrix.os == 'ubuntu-latest'
              run: sudo apt-get update &&
                  sudo apt-get install -y xvfb x11-utils xdotool sway
            - name: Start xvfb
              if: matrix.os == 'ubuntu-latest'
              run: |
                  export DISPLAY=:99
                  Xvfb :99 -screen 0 1024x768x24 &
            - run: cargo fmt -- --check
            - run: cargo clippy --all-features -- -D warnings
            - name: Test
              run: cargo test --all --all-features -- --test-threads=1
              env:
                  INTEGRATION_TEST: 1

